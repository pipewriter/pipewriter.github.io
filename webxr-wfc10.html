
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';const W=30,T=1.5,H=4,O=4,S=0.05,HEAD=1.6,SNAP=Math.PI/6,scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(innerWidth,innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,1e3),player=new THREE.Group();camera.position.set(0,HEAD,0);player.add(camera);scene.add(player);const light=new THREE.DirectionalLight(16777215,1);light.position.set(0,1,0);scene.add(light);function wfc(n,c,allow){const p=[];for(let y=0;y<n;y++){p[y]=[];for(let x=0;x<n;x++){p[y][x]=Array.from({length:c},(_,i)=>i)}}const neigh=(x,y)=>[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(v=>v[0]>=0&&v[0]<n&&v[1]>=0&&v[1]<n);for(let guard=0,res=!0;res&&guard<n*n*20;){guard++;let m=c+1,cs=[];for(let y=0;y<n;y++)for(let x=0;x<n;x++){const l=p[y][x].length;l>1&&l<m?(m=l,cs=[[x,y]]):l===m&&cs.push([x,y])}if(m===c+1){res=!1;break}const[fx,fy]=cs[Math.random()*cs.length|0],opts=p[fy][fx],pick=opts[Math.random()*opts.length|0];p[fy][fx]=[pick];const q=[[fx,fy]];while(q.length){const[qx,qy]=q.shift(),t=p[qy][qx][0];for(const[nx,ny]of neigh(qx,qy)){let poss=p[ny][nx];if(poss.length>1){const s=allow(t);poss=poss.filter(v=>s.includes(v));poss.length||(poss=[Math.random()*c|0]);if(poss.length!==p[ny][nx].length){p[ny][nx]=poss;q.push([nx,ny])}}}}}return p.map(r=>r.map(v=>v[0]))}const hAllow=t=>[t,Math.max(0,t-1),Math.min(H-1,t+1)],oAllow=()=>[0,1,2,3],hMap=wfc(W,H,hAllow),oMap=wfc(W,O,oAllow),hColors=[0x006400,0x228b22,0x8b7765,0xcccccc],objs=[null,new THREE.BoxGeometry(.6,.6,.6),new THREE.SphereGeometry(.4,16,16),new THREE.ConeGeometry(.4,.8,8)],objMats=[null,new THREE.MeshStandardMaterial({color:0xff0000}),new THREE.MeshStandardMaterial({color:0x0000ff}),new THREE.MeshStandardMaterial({color:0xffff00})];for(let y=0;y<W;y++)for(let x=0;x<W;x++){const h=hMap[y][x],hVal=.3+.5*h,bg=new THREE.BoxGeometry(T,hVal,T),bm=new THREE.MeshStandardMaterial({color:hColors[h]}),bmesh=new THREE.Mesh(bg,bm);bmesh.position.set((x-W/2)*T,hVal/2,(y-W/2)*T);scene.add(bmesh);const o=oMap[y][x];if(o){const g=objs[o].clone(),m=objMats[o].clone(),mesh=new THREE.Mesh(g,m);mesh.position.set((x-W/2)*T,hVal+(o===2?.4:.3),(y-W/2)*T);scene.add(mesh)}}window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight,camera.updateProjectionMatrix(),renderer.setSize(innerWidth,innerHeight)});let snapReady=!0;function heightAt(x,z){const gx=Math.floor(x/T+W/2),gz=Math.floor(z/T+W/2);if(gx<0||gx>=W||gz<0||gz>=W)return 0;return .3+.5*hMap[gz][gx]}renderer.setAnimationLoop(()=>{const s=renderer.xr.getSession();if(s){for(const i of s.inputSources){if(!i.gamepad)continue;const a=i.gamepad.axes,hnd=i.handedness;if(hnd==='right'){const dx=a[0],dz=a[1];if(Math.hypot(dx,dz)>.05){const dir=new THREE.Vector3();camera.getWorldDirection(dir);dir.y=0;dir.normalize();const right=new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0),dir).normalize();player.position.addScaledVector(dir,-dz*S);player.position.addScaledVector(right,dx*S)}}else if(hnd==='left'){const lx=a[0];if(Math.abs(lx)>.7&&snapReady){player.rotation.y+=lx>0?-SNAP:SNAP;snapReady=!1}if(Math.abs(lx)<.3)snapReady=!0}}}player.position.y=heightAt(player.position.x,player.position.z)+HEAD;renderer.render(scene,camera)});</script></body></html>
