<html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as T from"https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js";import{VRButton as B}from"https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/VRButton.js";const S=50,H=5,O=5,PH=1.6,SPD=.06,SNAP=Math.PI/4;function wfc(s,t){for(;;){const o=Array.from({length:s},()=>Array.from({length:s},()=>Array.from({length:t},(_,i)=>i))),n=(x,y)=>[[x-1,y],[x+1,y],[x,y-1],[x,y+1]].filter(([a,b])=>a>=0&&a<s&&b>=0&&b<s);for(;;){let m=t+1,h=[];for(let y=0;y<s;y++)for(let x=0;x<s;x++){const p=o[y][x];p.length>1&&p.length<m?(m=p.length,h=[[x,y]]):p.length===m&&h.push([x,y])}if(!h.length)break;const[r,u]=h[Math.random()*h.length|0],cell=o[u][r],choice=cell[Math.random()*cell.length|0];o[u][r]=[choice];const st=[[r,u]];while(st.length){const[cx,cy]=st.pop(),val=o[cy][cx][0];for(const[nx,ny]of n(cx,cy)){const q=o[ny][nx];if(q.length>1){const l=q.length;o[ny][nx]=q.filter(v=>v!==val);if(!o[ny][nx].length)return null;o[ny][nx].length<l&&st.push([nx,ny])}}}}return o.map(r=>r.map(v=>v[0]))}}let hMap,oMap;do hMap=wfc(S,H);while(!hMap);do oMap=wfc(S,O);while(!oMap);const scene=new T.Scene(),rig=new T.Group();scene.add(rig);const cam=new T.PerspectiveCamera(70,innerWidth/innerHeight,.1,1e3);rig.add(cam);const ren=new T.WebGLRenderer({antialias:1});ren.setSize(innerWidth,innerHeight);ren.xr.enabled=1;document.body.appendChild(ren.domElement);document.body.appendChild(B.createButton(ren));scene.add(new T.HemisphereLight(16777215,4473924,1));const hCol=[0x2e7d32,0x43a047,0x66bb6a,0xa5d6a7,0xeeeeee],gGeo=new T.BoxGeometry(1,1,1),gMat=new T.MeshLambertMaterial({vertexColors:1}),ground=new T.InstancedMesh(gGeo,gMat,S*S);ground.instanceMatrix.setUsage(T.DynamicDrawUsage);const col=new T.Color();let id=0;for(let z=0;z<S;z++)for(let x=0;x<S;x++){const h=hMap[z][x]+1,m=new T.Matrix4().makeScale(1,h,1).setPosition(x,h*.5,z);ground.setMatrixAt(id,m);col.setHex(hCol[hMap[z][x]]);ground.setColorAt(id++,col)}scene.add(ground);const sGeo=[,new T.BoxGeometry(.8,.8,.8),new T.SphereGeometry(.4,16,16),new T.ConeGeometry(.4,1,16),new T.CylinderGeometry(.4,.4,.8,16)],sMat=[,new T.MeshLambertMaterial({color:0xff5555}),new T.MeshLambertMaterial({color:0x5555ff}),new T.MeshLambertMaterial({color:0xffff55}),new T.MeshLambertMaterial({color:0x55ffff})];for(let t=1;t<O;t++){const cnt=oMap.flat().filter(v=>v===t).length;if(!cnt)continue;const inst=new T.InstancedMesh(sGeo[t],sMat[t],cnt);let j=0;for(let z=0;z<S;z++)for(let x=0;x<S;x++)if(oMap[z][x]===t){const y=hMap[z][x]+1;inst.setMatrixAt(j++,new T.Matrix4().setPosition(x,y+.4,z))}scene.add(inst)}addEventListener("resize",()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();ren.setSize(innerWidth,innerHeight)});const ctrls=[ren.xr.getController(0),ren.xr.getController(1)];ctrls.forEach(c=>rig.add(c));const prev=[0,0];ren.setAnimationLoop(()=>{for(let i=0;i<ctrls.length;i++){const gp=ctrls[i].gamepad;if(!gp)continue;const ax=gp.axes;if(i===0){if(Math.abs(ax[2])>.8&&Math.abs(prev[i])<=.8)rig.rotation.y+=ax[2]>0?-SNAP:SNAP;prev[i]=ax[2]}else{const dir=new T.Vector3();cam.getWorldDirection(dir);dir.y=0;dir.normalize();const side=new T.Vector3().crossVectors(new T.Vector3(0,1,0),dir).normalize();rig.position.addScaledVector(dir,-ax[3]*SPD);rig.position.addScaledVector(side,ax[2]*SPD)}}const gx=Math.round(rig.position.x),gz=Math.round(rig.position.z),gh=gx>=0&&gx<S&&gz>=0&&gz<S?hMap[gz][gx]:0;rig.position.y=gh+PH;ren.render(scene,cam)});</script></body></html>