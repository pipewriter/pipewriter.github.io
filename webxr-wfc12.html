
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as T from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton as V}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';const S=new T.Scene(),R=new T.WebGLRenderer({antialias:!0});R.setSize(innerWidth,innerHeight);R.xr.enabled=!0;document.body.append(R.domElement,V.createButton(R));const rig=new T.Group;S.add(rig);const C=new T.PerspectiveCamera(70,innerWidth/innerHeight,.1,1e3);rig.add(C);S.add(new T.HemisphereLight(16777215,4473924,1));const gS=30,tS=1.5,hCnt=7,oCnt=6,spd=.06,uH=1.6,hColors=[16711680,65280,255,16776960,16711935,65535,16777215],oColors=[11184810,16753920,16724787,16776960,65343,65535];function neigh(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>p[0]>=0&&p[0]<gS&&p[1]>=0&&p[1]<gS)}function allow(t,c){return[t,(t+1)%c,(t+c-1)%c]}function wfc(cnt){const p=[];for(let y=0;y<gS;y++){p[y]=[];for(let x=0;x<gS;x++)p[y][x]=Array.from({length:cnt},(_,i)=>i)}let u=!0,g=0;for(;u&&g<gS*gS*20;){g++;let m=cnt+1,ch=[];for(let y=0;y<gS;y++)for(let x=0;x<gS;x++){const l=p[y][x].length;l>1&&l<m?(m=l,ch=[[x,y]]):l===m&&ch.push([x,y])}if(m===cnt+1){u=!1;break}const[dX,dY]=ch[Math.random()*ch.length|0],opt=p[dY][dX],pick=opt[Math.random()*opt.length|0];p[dY][dX]=[pick];const q=[[dX,dY]];for(;q.length;){const[qx,qy]=q.shift(),t=p[qy][qx][0];for(const[nx,ny]of neigh(qx,qy)){let poss=p[ny][nx];if(poss.length>1){const a=allow(t,cnt);poss=poss.filter(v=>a.includes(v));poss.length||(poss=[Math.random()*cnt|0]);if(poss.length!==p[ny][nx].length){p[ny][nx]=poss;q.push([nx,ny])}}}}}return p.map(r=>r.map(v=>v[0]))}const hMap=wfc(hCnt),oMap=wfc(oCnt),groundH=[],oGeo=[null,new T.BoxGeometry(.6,.6,.6),new T.SphereGeometry(.35,8,8),new T.ConeGeometry(.35,.7,8),new T.CylinderGeometry(.3,.3,.7,8),new T.TorusGeometry(.4,.12,8,16)],oH=[0,.6,.7,.7,.7,.8];for(let y=0;y<gS;y++){groundH[y]=[];for(let x=0;x<gS;x++){const hi=hMap[y][x],hVal=.3*hi+.3;groundH[y][x]=hVal;const g=new T.BoxGeometry(tS,hVal,tS),m=new T.MeshStandardMaterial({color:hColors[hi%hColors.length]}),tile=new T.Mesh(g,m);tile.position.set((x-gS/2)*tS,hVal/2,(y-gS/2)*tS);S.add(tile);const oi=oMap[y][x];if(oi){const mesh=new T.Mesh(oGeo[oi],new T.MeshStandardMaterial({color:oColors[oi%oColors.length]}));mesh.position.set(tile.position.x,hVal+oH[oi]/2,tile.position.z);S.add(mesh)}}}const ctrls=[],addCtl=i=>{const c=R.xr.getController(i);c.addEventListener('connected',e=>{c.userData.is=e.data.handedness;ctrls.push(c)});S.add(c)};addCtl(0);addCtl(1);let turnOK=!0;R.setAnimationLoop(()=>{for(const c of ctrls){const g=c.userData?.targetRaySpace?.gamepad||c.inputSource?.gamepad||c.userData.gamepad||c.userData.inputSource?.gamepad;if(!g)continue;const a=g.axes,hand=c.userData.is;if(hand==='right'){const x=a[2]??a[0]??0,z=a[3]??a[1]??0;if(Math.abs(x)+Math.abs(z)>.05){const dir=new T.Vector3(x,0,z).applyAxisAngle(new T.Vector3(0,1,0),rig.rotation.y).multiplyScalar(spd);rig.position.add(dir)}}else if(hand==='left'){const t=a[2]??a[0]??0;if(Math.abs(t)>.7&&turnOK){rig.rotation.y+=t>0?-Math.PI/4:Math.PI/4;turnOK=!1}else if(Math.abs(t)<.2)turnOK=!0}}const gx=Math.floor((rig.position.x+gS*tS/2)/tS),gz=Math.floor((rig.position.z+gS*tS/2)/tS);if(gx>=0&&gx<gS&&gz>=0&&gz<gS)rig.position.y=groundH[gz][gx]+uH;R.render(S,C)});addEventListener('resize',()=>{C.aspect=innerWidth/innerHeight;C.updateProjectionMatrix();R.setSize(innerWidth,innerHeight)});</script></body></html>
