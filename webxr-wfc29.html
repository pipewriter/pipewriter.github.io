
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';const scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);scene.add(camera);const light=new THREE.DirectionalLight(16777215,1);light.position.set(0,50,50);scene.add(light);const gridSize=20,tileSize=1.6,fixedHeight=2;const heightCount=6,objectCount=5,heightColors=[0x317a2e,0x46c141,0x82d164,0xd5e684,0xf0dc8d,0xc2b280],objectColors=[0x000000,0xe32636,0x3b83bd,0xffa500,0x782f40];const heightPatterns=[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0]];const allowedObjs=[[0,1,2,3,4],[0,1,2,3,4],[0,1],[1,2,3],[0,1,2,3,4]];let heightWFC=[],objWFC=[];function emptyArray(v,n){return Array(n).fill().map(()=>[...v])}function neighbors(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(([a,b])=>a>=0&&a<gridSize&&b>=0&&b<gridSize)}function collapseWFC(poss,patterns,count){let unresolved=!0,guard=0;for(;unresolved&&guard<gridSize*gridSize*20;) {guard++;let min=count+1,choices=[];for(let y=0;y<gridSize;y++) for(let x=0;x<gridSize;x++){let len=poss[y][x].length;len>1&&len<min?(min=len,choices=[[x,y]]):len===min&&choices.push([x,y]);}if(count+1===min){unresolved=!1;break;}let[cx,cy]=choices[Math.random()*choices.length|0],options=poss[cy][cx],pick=options[Math.random()*options.length|0];poss[cy][cx]=[pick];const queue=[[cx,cy]];while(queue.length){let[qx,qy]=queue.shift(),tile=poss[qy][qx][0];for(const[nx,ny]of neighbors(qx,qy)){let nposs=poss[ny][nx];if(nposs.length>1){let allowedSet=patterns[tile];nposs=nposs.filter(v=>allowedSet.includes(v));if(0===nposs.length)nposs=[Math.random()*count|0];if(nposs.length!==poss[ny][nx].length){poss[ny][nx]=nposs,queue.push([nx,ny])}}}}}}function randomObjCandidates(h){if      (h<=1)return [0,1,4];else if(h<=2)return [0,2];else if(h<=4)return [0,2,3];else return [0,3,4];}function collapseObjectWFC(heightMap){let objMap=emptyArray([0,1,2,3,4],gridSize);for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++)objMap[y][x]=randomObjCandidates(heightMap[y][x][0]);let unresolved=!0,guard=0;for(;unresolved&&guard<gridSize*gridSize*8;){guard++;let min=6,choices=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let len=objMap[y][x].length;len>1&&len<min?(min=len,choices=[[x,y]]):len===min&&choices.push([x,y])}if(6===min){unresolved=!1;break;}let[cx,cy]=choices[Math.random()*choices.length|0],options=objMap[cy][cx],pick=options[Math.random()*options.length|0];objMap[cy][cx]=[pick];const queue=[[cx,cy]];while(queue.length){let[qx,qy]=queue.shift(),tile=objMap[qy][qx][0];for(const[nx,ny]of neighbors(qx,qy)){let nposs=objMap[ny][nx];if(nposs.length>1){let allowedSet=allowedObjs[tile];nposs=nposs.filter(v=>allowedSet.includes(v));if(0===nposs.length)nposs=[0];if(nposs.length!==objMap[ny][nx].length){objMap[ny][nx]=nposs,queue.push([nx,ny])}}}}}return objMap}heightWFC=emptyArray([0,1,2,3,4,5],gridSize);collapseWFC(heightWFC,heightPatterns,heightCount);objWFC=collapseObjectWFC(heightWFC);function makeGroundTile(x,y,h){const geo=new THREE.BoxGeometry(tileSize,.26*tileSize,tileSize);geo.translate(0,-.13*tileSize,0);let mat=new THREE.MeshStandardMaterial({color:heightColors[h],vertexColors:!0});let mesh=new THREE.Mesh(geo,mat);mesh.position.set((x-gridSize/2)*tileSize,h*0.5,(y-gridSize/2)*tileSize);return mesh;}function makePrimitive(x,y,h,objId){const posx=(x-gridSize/2)*tileSize,posy=h*0.5+.4*tileSize,posz=(y-gridSize/2)*tileSize;if(objId===0)return null;let mesh=null,clr=objectColors[objId];if(objId===1){mesh=new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.65,16),new THREE.MeshStandardMaterial({color:clr}))}else if(objId===2){mesh=new THREE.Mesh(new THREE.SphereGeometry(.35,18,10),new THREE.MeshStandardMaterial({color:clr}))}else if(objId===3){mesh=new THREE.Mesh(new THREE.TorusGeometry(.28,.08,8,24),new THREE.MeshStandardMaterial({color:clr}))}else if(objId===4){mesh=new THREE.Mesh(new THREE.BoxGeometry(.48,.5,.48),new THREE.MeshStandardMaterial({color:clr}))}if(mesh){mesh.position.set(posx,posy,posz)}return mesh;}for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let h=heightWFC[y][x][0],objId=objWFC[y][x][0];let g=makeGroundTile(x,y,h);scene.add(g);let obj=makePrimitive(x,y,h,objId);if(obj)scene.add(obj);}let userRig=new THREE.Group;userRig.add(camera);scene.add(userRig);let playerPos={x:0,y:0},moveVel={x:0,z:0};let headYaw=0,rotatingLeft=!1,rotatingRight=!1,snapCooldown=0;function updateCameraRig(){let h=heightWFC[Math.round(playerPos.y+gridSize/2)]?.[Math.round(playerPos.x+gridSize/2)]?.[0];if(h===undefined)h=0;userRig.position.set(playerPos.x,fixedHeight+h*0.5,playerPos.y);userRig.rotation.y=headYaw;}function clamp(val,min,max){return val<min?min:val>max?max:val}renderer.xr.addEventListener("sessionstart",()=>{let prevRAF=null;let refSpace,parentSpace;renderer.xr.getSession().requestReferenceSpace('local').then(s=>{refSpace=s});renderer.setAnimationLoop(loop);function loop(t){if(prevRAF==null)prevRAF=t;let dt=Math.min(.12,(t-prevRAF)/1000);prevRAF=t;let session=renderer.xr.getSession();if(session){let gamepads=navigator.getGamepads();for(let i=0;i<2;i++){let gp=gamepads[i];if(gp&&gp.connected&&gp.mapping==="xr-standard"){let lx=gp.axes[2]||0,ly=gp.axes[3]||0,rx=gp.axes[0]||0,ry=gp.axes[1]||0;let mag=Math.sqrt(lx*lx+ly*ly);if(mag>.25){let angle=headYaw;moveVel.x+=Math.sin(angle)*ly*.08;moveVel.z+=Math.cos(angle)*ly*.08;moveVel.x+=Math.cos(angle)*lx*.08;moveVel.z+=-Math.sin(angle)*lx*.08;}else moveVel.x*=.8,moveVel.z*=.8;if(Math.abs(rx)>.5&&snapCooldown<=0){headYaw+=rx>.5?.436:-.436;snapCooldown=.25;}else if(Math.abs(rx)<=.3)snapCooldown-=dt;if(playerPos.x+moveVel.x>-gridSize/2+.8&&playerPos.x+moveVel.x<gridSize/2-.8)playerPos.x+=moveVel.x;else moveVel.x=0;if(playerPos.y+moveVel.z>-gridSize/2+.8&&playerPos.y+moveVel.z<gridSize/2-.8)playerPos.y+=moveVel.z;else moveVel.z=0;updateCameraRig();}}renderer.render(scene,camera);}}});window.addEventListener('resize',()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();});renderer.setAnimationLoop(()=>{updateCameraRig();renderer.render(scene,camera);});</script></body></html>
