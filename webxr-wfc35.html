
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';let scene=new THREE.Scene,renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight),renderer.xr.enabled=!0,document.body.appendChild(renderer.domElement),document.body.appendChild(VRButton.createButton(renderer));let camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3),container=new THREE.Group;scene.add(container);let playerHeadHeight=1.7,playerY=0;camera.position.set(0,playerHeadHeight,0),container.add(camera);let light=new THREE.DirectionalLight(16777215,1);light.position.set(0,1,0),scene.add(light);let gridSize=16,tileSize=1.5,heightCount=8,surfaceColors=[16736851,8042931,6274422,5066061,3265547,2662163,16698970,16777215],heightTiles=[],colorTiles=[];for(let i=0;i<heightCount;i++){let g=new THREE.BoxGeometry(tileSize,.2*tileSize,tileSize),m=new THREE.MeshStandardMaterial({color:surfaceColors[i]});heightTiles.push(new THREE.Mesh(g,m))}let objTypes=["none","cube","sphere","cone"],objColors=[0x111111,0xff4400,0x7711ee,0x00ccee],objectMeshes={};for(let type of objTypes)if("none"!==type){let mesh;switch(type){case"cube":mesh=new THREE.Mesh(new THREE.BoxGeometry(.7*tileSize,.7*tileSize,.7*tileSize),new THREE.MeshStandardMaterial);break;case"sphere":mesh=new THREE.Mesh(new THREE.SphereGeometry(.4*tileSize,16,8),new THREE.MeshStandardMaterial);break;case"cone":mesh=new THREE.Mesh(new THREE.ConeGeometry(.35*tileSize,.75*tileSize,16),new THREE.MeshStandardMaterial);break}objectMeshes[type]=mesh}function randomChoice(arr){return arr[Math.random()*arr.length|0]}let heightPoss=[],objPoss=[];for(let y=0;y<gridSize;y++){heightPoss[y]=[],objPoss[y]=[];for(let x=0;x<gridSize;x++)heightPoss[y][x]=[0,1,2,3,4,5,6,7],objPoss[y][x]=[0,0,0,1,2,3]}function allowedHeight(t){return[t,Math.max(0,t-1),Math.min(heightCount-1,t+1)]}function neighbors(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>p[0]>=0&&p[0]<gridSize&&p[1]>=0&&p[1]<gridSize)}function wfcCollapse(possArr,allowedFun,count,maxChoices){let unresolved=!0,guard=0;for(;unresolved&&guard<gridSize*gridSize*10;){guard++;let min=maxChoices+1,choices=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let len=possArr[y][x].length;len>1&&len<min?(min=len,choices=[[x,y]]):len==min&&choices.push([x,y])}if(min===maxChoices+1){unresolved=!1;break}let[cx,cy]=randomChoice(choices),options=possArr[cy][cx],pick=randomChoice(options);possArr[cy][cx]=[pick];let queue=[[cx,cy]];for(;queue.length;){let[qx,qy]=queue.shift(),tile=possArr[qy][qx][0];for(let[nx,ny]of neighbors(qx,qy)){let poss=possArr[ny][nx];if(poss.length>1){let allowedSet=allowedFun(tile);if(poss=poss.filter(v=>allowedSet.includes(v)),poss.length||possArr==objPoss||(poss=[randomChoice([...Array(count).keys()])]),poss.length!==possArr[ny][nx].length)possArr[ny][nx]=poss,queue.push([nx,ny])}}}}}wfcCollapse(heightPoss,allowedHeight,heightCount,heightCount);function allowedObj(t){return[0,1,2,3]}wfcCollapse(objPoss,allowedObj,4,4);let groundMeshes=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let h=heightPoss[y][x][0],mesh=heightTiles[h].clone();let px=(x-gridSize/2)*tileSize,pz=(y-gridSize/2)*tileSize,py=(h-.5*heightCount)*.3*tileSize;mesh.position.set(px,py,pz),scene.add(mesh),groundMeshes.push({x,y,px,py,pz,h});let oT=objTypes[objPoss[y][x][0]],oC=objColors[objPoss[y][x][0]];if("none"!==oT){let oMesh=objectMeshes[oT].clone();oMesh.material=oMesh.material.clone(),oMesh.material.color.set(oC),oMesh.position.set(px,py+.75*tileSize,pz),scene.add(oMesh)}}function getHeightAt(x,z){let fx=(x/tileSize|0)+gridSize/2,fz=(z/tileSize|0)+gridSize/2;if(fx<0||fz<0||fx>=gridSize||fz>=gridSize)return 0;return (heightPoss[fz][fx][0]-.5*heightCount)*.3*tileSize}let moveSpeed=0.04,rotSnap=THREE.MathUtils.degToRad(30),rotCooldown=0;renderer.xr.addEventListener("sessionstart",()=>{navigator.xr&&renderer.xr.getSession().requestReferenceSpace("local-floor")});function vec3move(dir,angle){return[Math.sin(angle)*dir[2]+Math.cos(angle)*dir[0],dir[1],-Math.cos(angle)*dir[2]+Math.sin(angle)*dir[0]]}renderer.setAnimationLoop(()=>{let session=renderer.xr.getSession();if(session){let sources=session.inputSources;for(let src of sources)if(src&&src.gamepad){let gp=src.gamepad,axes=gp.axes;let handed=src.handedness,pos=container.position.clone(),rot=container.rotation.y;let joyX=axes[2],joyY=axes[3],joyLX=axes[0],joyLY=axes[1];if(Math.abs(joyY)>0.1||Math.abs(joyX)>0.1){let move=[joyX*moveSpeed,0,-joyY*moveSpeed],rotAngle=container.rotation.y+[0][0];let [mx,,mz]=vec3move(move,rotAngle),nx=container.position.x+mx,nz=container.position.z+mz,ny;ny=getHeightAt(nx,nz)+playerHeadHeight;container.position.set(nx,ny,nz)}if(Math.abs(joyLX)>0.5&&rotCooldown<=0){container.rotation.y-=Math.sign(joyLX)*rotSnap,rotCooldown=15}else rotCooldown=Math.max(0,rotCooldown-1);let groundY=getHeightAt(container.position.x,container.position.z);container.position.y=groundY+playerHeadHeight}}renderer.render(scene,camera)});window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)})</script></body></html>
