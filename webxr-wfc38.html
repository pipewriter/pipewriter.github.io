
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';let gridSize=16,tileSize=2,tileCount=7,colors=[16711680,65280,255,16776960,16711935,65535,16777215],tiles=[];let heightTileCount=6,heightColors=[0x233a22,0x336633,0x888238,0xa0b07c,0xc7e7ff,0xffffff];let objectTileCount=5,objectColors=[0x444444,0xffbac6,0x335aff,0xffff33,0xffab23];let nothingObjectIdx=0;const objectPrimitives=[null,'box','sphere','cone','torus'];const scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:1});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=1;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);scene.add(camera);const light=new THREE.DirectionalLight(0xffffff,1);light.position.set(1,3,2);scene.add(light);const ambi=new THREE.AmbientLight(0x888888,0.5);scene.add(ambi);for(let i=0;i<tileCount;i++){let g=new THREE.BoxGeometry(tileSize,.15*tileSize,tileSize),m=new THREE.MeshStandardMaterial({color:colors[i]});tiles.push(new THREE.Mesh(g,m))}function allowed(t,cnt){return[t,(t+1)%cnt,(t+cnt-1)%cnt]}function neighbors(x,y,gsz){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>p[0]>=0&&p[0]<gsz&&p[1]>=0&&p[1]<gsz)}function wfc(gsz,cnt,forbidden){let poss=[];for(let y=0;y<gsz;y++){poss[y]=[];for(let x=0;x<gsz;x++)poss[y][x]=[...Array(cnt).keys()].filter(t=>(forbidden?forbidden(x,y,t):1))}let unresolved=1,guard=0;for(;unresolved&&guard<gsz*gsz*10;){guard++;let min=cnt+1,choices=[];for(let y=0;y<gsz;y++)for(let x=0;x<gsz;x++){let l=poss[y][x].length;l>1&&l<min?(min=l,choices=[[x,y]]):l===min&&choices.push([x,y])}if(cnt+1===min){unresolved=0;break}let[cx,cy]=choices[Math.random()*choices.length|0],options=poss[cy][cx],pick=options[Math.random()*options.length|0];poss[cy][cx]=[pick];let queue=[[cx,cy]];for(;queue.length;){let[qx,qy]=queue.shift(),tile=poss[qy][qx][0];for(let[nx,ny]of neighbors(qx,qy,gsz)){let p=poss[ny][nx];if(p.length>1){const allowedSet=allowed(tile,cnt);if(p=p.filter(v=>allowedSet.includes(v)),0===p.length&&(p=[Math.random()*cnt|0]),p.length!==poss[ny][nx].length){poss[ny][nx]=p,queue.push([nx,ny])}}}}}return poss}let heightPoss=wfc(gridSize,heightTileCount),objectPoss=wfc(gridSize,objectTileCount,(x,y,t)=>(t!==nothingObjectIdx||Math.random()<.7));let meshes=[],objMeshes=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let hi=heightPoss[y][x][0],h=(hi-heightTileCount/2)*tileSize*0.37,geom=new THREE.BoxGeometry(tileSize,0.1*tileSize,tileSize),col=heightColors[hi],mat=new THREE.MeshStandardMaterial({color:col});let mesh=new THREE.Mesh(geom,mat);mesh.position.set((x-gridSize/2)*tileSize,h,(y-gridSize/2)*tileSize);scene.add(mesh);meshes[y]=meshes[y]||[];meshes[y][x]=mesh;let oi=objectPoss[y][x][0];if(oi!==nothingObjectIdx){let kind=objectPrimitives[oi],ocol=objectColors[oi]||0xffffff,objm;switch(kind){case'box':objm=new THREE.Mesh(new THREE.BoxGeometry(0.6*tileSize,0.6*tileSize,0.6*tileSize),new THREE.MeshStandardMaterial({color:ocol}));break;case'sphere':objm=new THREE.Mesh(new THREE.SphereGeometry(0.38*tileSize,16,12),new THREE.MeshStandardMaterial({color:ocol}));break;case'cone':objm=new THREE.Mesh(new THREE.ConeGeometry(0.3*tileSize,0.7*tileSize,16),new THREE.MeshStandardMaterial({color:ocol}));break;case'torus':objm=new THREE.Mesh(new THREE.TorusGeometry(0.27*tileSize,0.13*tileSize,14,18),new THREE.MeshStandardMaterial({color:ocol}));break;}if(objm)objm.position.set((x-gridSize/2)*tileSize,h+tileSize*0.42,(y-gridSize/2)*tileSize),scene.add(objm),objMeshes.push(objm)}}let moveDir=new THREE.Vector3,rotating=0,snapAngle=Math.PI/6,vrCtlState={leftX:0,leftY:0,rightX:0,rightY:0},player={x:gridSize/2,y:gridSize/2};function getGroundHeight(x,z){let gx=Math.round(x/tileSize+gridSize/2),gz=Math.round(z/tileSize+gridSize/2);gx=Math.max(0,Math.min(gridSize-1,gx));gz=Math.max(0,Math.min(gridSize-1,gz));return meshes[gz]&&meshes[gz][gx]?meshes[gz][gx].position.y:0}renderer.xr.addEventListener("sessionstart",()=>{let refSpace,session=renderer.xr.getSession();session.addEventListener("inputsourceschange",()=>{});function onCtrl(ctrl,hand){if(ctrl.gamepad&&ctrl.handedness){let axes=ctrl.gamepad.axes;ctrl.handedness==="left"?(vrCtlState.leftX=axes[2]||axes[0],vrCtlState.leftY=axes[3]||axes[1]):(vrCtlState.rightX=axes[2]||axes[0],vrCtlState.rightY=axes[3]||axes[1])}}session.addEventListener("select",()=>{});renderer.setAnimationLoop((ts,frame)=>{let viewerPose=renderer.xr.getCamera(camera),userHead=viewerPose.children[0],dt=0.016;let speed=3;moveDir.set(0,0,0);if(Math.abs(vrCtlState.rightY)>.14){moveDir.z=-vrCtlState.rightY}if(Math.abs(vrCtlState.rightX)>.14){moveDir.x=vrCtlState.rightX}let yaw=Math.atan2(userHead.matrix.elements[8],userHead.matrix.elements[10]);let moveWorld=new THREE.Vector3(moveDir.x,0,moveDir.z).applyAxisAngle(new THREE.Vector3(0,1,0),yaw).multiplyScalar(dt*speed);player.x+=moveWorld.x;player.y+=moveWorld.z;let px=player.x,py=player.y;let gx=px,gy=py;let wx=(gx-gridSize/2)*tileSize,wz=(gy-gridSize/2)*tileSize;let ground=getGroundHeight(wx,wz);camera.position.set(wx,ground+1.6,wz);let snapInput=vrCtlState.leftX;if(!rotating&&Math.abs(snapInput)>.6){let ang=snapInput>0?snapAngle:-snapAngle;userHead.parent.rotation.y+=ang;rotating=1}else if(Math.abs(snapInput)<.5)rotating=0;if(frame)for(let src of session.inputSources)onCtrl(src,src.handedness);renderer.render(scene,camera)})});renderer.setAnimationLoop(()=>{renderer.render(scene,camera)});</script></body></html>
