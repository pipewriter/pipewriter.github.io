
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';const scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);const PLAYER_HEIGHT=1.6;let playerY=0,playerPos=new THREE.Vector3(0,PLAYER_HEIGHT,0),playerRot=0;const light=new THREE.DirectionalLight(16777215,1);light.position.set(0,20,10);scene.add(light);scene.add(new THREE.AmbientLight(16777215,.3));const gridSize=20,tileSize=1.5,groundCount=7,objCount=6,groundColors=[16711680,65280,255,16776960,16711935,65535,16777215],objColors=[0,11184810,16711680,65280,255],objGeos=['none','box','sphere','cone','cylinder'],groundTiles=[],objects=[];for(let i=0;i<groundCount;i++){const g=new THREE.BoxGeometry(tileSize,.15*tileSize,tileSize),m=new THREE.MeshStandardMaterial({color:groundColors[i]});groundTiles.push(new THREE.Mesh(g,m))}function makeObjMesh(type,color){if(type===0)return null;if(type==1)return new THREE.Mesh(new THREE.BoxGeometry(.8,.8,.8),new THREE.MeshStandardMaterial({color}));if(type==2)return new THREE.Mesh(new THREE.SphereGeometry(.45,14,10),new THREE.MeshStandardMaterial({color}));if(type==3)return new THREE.Mesh(new THREE.ConeGeometry(.5,.9,12),new THREE.MeshStandardMaterial({color}));if(type==4)return new THREE.Mesh(new THREE.CylinderGeometry(.35,.35,.85,10),new THREE.MeshStandardMaterial({color}));}function wfc2d(count,opts,allowedFn){let p=[];for(let y=0;y<gridSize;y++){p[y]=[];for(let x=0;x<gridSize;x++)p[y][x]=[];for(let x=0;x<gridSize;x++)p[y][x]=[...Array(count)].map((_,i)=>i);}function n(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(([a,b])=>a>=0&&a<gridSize&&b>=0&&b<gridSize)}let g=0,u=1;while(u&&g<gridSize*gridSize*10){g++;let min=1e9,found=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let l=p[y][x].length;if(l>1&&l<min)min=l,found=[[x,y]];else if(l===min)found.push([x,y])}if(min==1e9){u=0;break}let[cx,cy]=found[(Math.random()*found.length)|0],options=p[cy][cx],pick=options[(Math.random()*options.length)|0];p[cy][cx]=[pick];let queue=[[cx,cy]];while(queue.length){let[qx,qy]=queue.shift(),t=p[qy][qx][0];for(let[xx,yy]of n(qx,qy)){let base=p[yy][xx];if(base.length>1){let allowed=allowedFn(t,[qx-xx,qy-yy]);base=base.filter(v=>allowed.has(v));if(!base.length)base=[Math.random()*count|0];if(base.length!==p[yy][xx].length)p[yy][xx]=base,queue.push([xx,yy]);}}}}return p;}function groundAllowed(t){return new Set([t,(t+1)%groundCount,(t+groundCount-1)%groundCount]);}function objAllowed(t){return new Set([0,1,2,3,4]);}const heights2d=wfc2d(groundCount,{},groundAllowed),heightMap=[],colorMap=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){const t=heights2d[y][x][0];heightMap[y*gridSize+x]=Math.floor(t/2),colorMap[y*gridSize+x]=groundColors[t];}const objects2d=wfc2d(objCount,{},objAllowed),objTypeMap=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){objTypeMap[y*gridSize+x]=objects2d[y][x][0];}for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){const i=y*gridSize+x,h=heightMap[i],color=colorMap[i],objtype=objTypeMap[i];const mesh=groundTiles[heights2d[y][x][0]].clone();mesh.position.set((x-gridSize/2)*tileSize,h*0.7,(y-gridSize/2)*tileSize);mesh.userData.gX=x;mesh.userData.gY=y;mesh.userData.gH=h;mesh.userData.gColor=color;mesh.userData.isGround=1;mesh.material=new THREE.MeshStandardMaterial({color,color:color,vertexColors:!1});scene.add(mesh);let obj=makeObjMesh(objtype,objColors[objtype]);if(obj)obj.position.set(mesh.position.x,mesh.position.y+.45,mesh.position.z),scene.add(obj);}function getGroundHeightAt(x,z){let fx=(x/tileSize)+.5*gridSize,fz=(z/tileSize)+.5*gridSize,gx=Math.round(fx),gz=Math.round(fz);if(gx>=0&&gx<gridSize&&gz>=0&&gz<gridSize)return heightMap[gz*gridSize+gx]*0.7;return 0;}let rightAxes=[0,0],leftAxes=[0,0],snapRotState=0;function handleGamePads(){const pads=navigator.getGamepads(),pad=pads[0];if(pad){if(pad.axes.length>2){rightAxes=[pad.axes[2],pad.axes[3]];leftAxes=[pad.axes[0],pad.axes[1]];}else{rightAxes=[0,0];leftAxes=[0,0];}let x=leftAxes[0];if(x>.7&&snapRotState===0){playerRot-=Math.PI/4;snapRotState=1;}else if(x<-.7&&snapRotState===0){playerRot+=Math.PI/4;snapRotState=1;}else if(Math.abs(x)<.3){snapRotState=0;}}}function updatePlayer(){let moveSpeed=.045,dir=new THREE.Vector3(-rightAxes[0],0,-rightAxes[1]).normalize().multiplyScalar(moveSpeed);let rotMat=new THREE.Matrix4().makeRotationY(playerRot);dir.applyMatrix4(rotMat);playerPos.add(dir);playerY=getGroundHeightAt(playerPos.x,playerPos.z);camera.position.set(playerPos.x,playerY+PLAYER_HEIGHT,playerPos.z);camera.rotation.y=playerRot;}renderer.setAnimationLoop(()=>{handleGamePads();updatePlayer();renderer.render(scene,camera);});window.addEventListener('resize',()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();});</script></body></html>
```
