
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';const scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);scene.add(camera);const light=new THREE.DirectionalLight(16777215,1);light.position.set(0,1,0);scene.add(light);const gridSize=16,tileSize=1.5,heightMin=0,heightMax=6,tileCount=7,colors=[16711680,65280,255,16776960,16711935,65535,16777215],heightColors=[0x357ec7,0x52cbff,0x59955c,0xa2d149,0xdfef8e,0xcfb53b,0x9c6615],objectTypes=["none","cube","sphere","cone"],objectColors=[0xffffff,0xee2222,0x44ee44,0x2244ee],tiles=[];for(let i=0;i<tileCount;i++){const g=new THREE.BoxGeometry(tileSize,.15*tileSize,tileSize),m=new THREE.MeshStandardMaterial({color:colors[i]});tiles.push(new THREE.Mesh(g,m))}function generateWFCLayer(states,allowed,init){const wfc=[];for(let y=0;y<gridSize;y++){wfc[y]=[];for(let x=0;x<gridSize;x++)wfc[y][x]=init(x,y)}let unresolved=!0,guard=0;for(;unresolved&&guard<gridSize*gridSize*20;){guard++;let min=999,choices=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){const len=wfc[y][x].length;len>1&&len<min?(min=len,choices=[[x,y]]):len===min&&choices.push([x,y])}if(min===999)break;const[cx,cy]=choices[Math.random()*choices.length|0],options=wfc[cy][cx],pick=options[Math.random()*options.length|0];wfc[cy][cx]=[pick];const queue=[[cx,cy]];while(queue.length){const[qx,qy]=queue.shift(),val=wfc[qy][qx][0];for(const[n of[[qx+1,qy],[qx-1,qy],[qx,qy+1],[qx,qy-1]]){const[nx,ny]=n;if(nx<0||nx>=gridSize||ny<0||ny>=gridSize)continue;let poss=wfc[ny][nx];if(poss.length>1){const allowedSet=allowed(val);const filtered=poss.filter(v=>allowedSet.includes(v));if(filtered.length!==poss.length){wfc[ny][nx]=filtered.length?filtered:[Math.random()*states|0];queue.push([nx,ny])}}}}unresolved=!1;for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++)if(wfc[y][x].length>1)unresolved=!0}}return wfc.map(row=>row.map(cell=>cell[0]))}const heightAllowed=t=>[t,Math.max(heightMin,Math.min(heightMax-1,t+1)),Math.max(heightMin,Math.min(heightMax-1,t-1))],objAllowed=o=>[0,1,2,3],heightInit=()=>Array.from({length:heightMax-heightMin},(_,i)=>i+heightMin),objectInit=()=>[0,1,2,3];const heights=generateWFCLayer(heightMax-heightMin,heightAllowed,heightInit),objects=generateWFCLayer(4,objAllowed,objectInit);const tileMeshes=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){const h=heights[y][x],obj=objects[y][x];const geometry=new THREE.BoxGeometry(tileSize,.2+0.9*h,tileSize);const color=heightColors[h%heightColors.length];geometry.computeVertexNormals();const mat=new THREE.MeshStandardMaterial({color:color});const mesh=new THREE.Mesh(geometry,mat);mesh.position.set((x-gridSize/2)*tileSize,0.5*h,(y-gridSize/2)*tileSize);mesh.userData={baseY:0.5*h,obj:obj};scene.add(mesh);tileMeshes.push(mesh);if(obj!==0){let primitive,mat2;switch(obj){case 1:primitive=new THREE.BoxGeometry(.7,.7,.7);break;case 2:primitive=new THREE.SphereGeometry(.39,16,12);break;case 3:primitive=new THREE.ConeGeometry(.45,.8,10);break;}mat2=new THREE.MeshStandardMaterial({color:objectColors[obj]});const omesh=new THREE.Mesh(primitive,mat2);omesh.position.set(mesh.position.x,mesh.position.y+0.65,mesh.position.z);scene.add(omesh)}}let playerY=2,camY=0,px=0,pz=0,yaw=0;function findGroundHeight(x,z){x=(x+gridSize*tileSize/2)/tileSize;z=(z+gridSize*tileSize/2)/tileSize;const xi=Math.floor(x),zi=Math.floor(z);if(xi<0||zi<0||xi>=gridSize||zi>=gridSize)return 0;return tileMeshes[zi*gridSize+xi].position.y+.6}function updateCamera(){camY=findGroundHeight(px,pz)+playerY;camera.position.set(px,camY,pz);camera.rotation.y=yaw}let moveF=0,moveS=0,turnQueued=0,lastThumbstickTime=0;function lerp(a,b,t){return a+(b-a)*t}renderer.xr.addEventListener("sessionstart",()=>{const session=renderer.xr.getSession();session.addEventListener("inputsourceschange",()=>{});});function handleControllers(){const session=renderer.xr.getSession();if(!session)return;const sources=session.inputSources;for(const src of sources){if(!src.gamepad)continue;const axes=src.gamepad.axes,buttons=src.gamepad.buttons;let handed=(src.handedness||"unknown");if(axes.length>=2){if(handed=="right"||handed=="unknown"){moveS=axes[0];moveF=-axes[1];}else{if(Math.abs(axes[2])>0.67&&Date.now()-lastThumbstickTime>210){turnQueued=axes[2]>0?1:-1;lastThumbstickTime=Date.now();}}}}}let snapRot=THREE.MathUtils.degToRad(35);renderer.setAnimationLoop(()=>{handleControllers();if(turnQueued){yaw+=snapRot*turnQueued;turnQueued=0;}const speed=0.045,ang=yaw;let dx=moveS*Math.cos(ang)-moveF*Math.sin(ang),dz=moveS*Math.sin(ang)+moveF*Math.cos(ang);px+=dx*speed;pz+=dz*speed;updateCamera();renderer.render(scene,camera)});window.addEventListener("resize",()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix()});</script></body></html>
