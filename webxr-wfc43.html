
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';const scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);let playerHeight=2.2,player={x:0,z:0,y:0,rot:0};const floorOffset=0.02;const gridSize=20,tileSize=1.5;const groundTileCount=7,groundColors=[16711680,65280,255,16776960,16711935,65535,16777215];const groundTiles=[],heightMap=[],colorMap=[],objectTiles=[];for(let i=0;i<groundTileCount;i++){const g=new THREE.BoxGeometry(tileSize,.15*tileSize,tileSize),m=new THREE.MeshStandardMaterial({color:groundColors[i]});groundTiles.push(new THREE.Mesh(g,m))}function allowed(t){return[t,(t+1)%groundTileCount,(t+groundTileCount-1)%groundTileCount]}function neighbors(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>p[0]>=0&&p[0]<gridSize&&p[1]>=0&&p[1]<gridSize)}function wfcLayer(tileCt,allowF,seedVal){let possibilities=[];for(let y=0;y<gridSize;y++){possibilities[y]=[];for(let x=0;x<gridSize;x++)possibilities[y][x]=[];possibilities[y].forEach((_,x)=>possibilities[y][x]=[...Array(tileCt).keys()])}function collapseOne(){let unresolved=!0,guard=0;for(;unresolved&&guard<gridSize*gridSize*10;){guard++;let min=tileCt+1,choices=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){const len=possibilities[y][x].length;len>1&&len<min?(min=len,choices=[[x,y]]):len===min&&choices.push([x,y])}if(tileCt+1===min){unresolved=!1;break}const[cx,cy]=choices[Math.random()*choices.length|0],options=possibilities[cy][cx],pick=options[Math.random()*options.length|0];possibilities[cy][cx]=[pick];const queue=[[cx,cy]];for(;queue.length;){const[qx,qy]=queue.shift(),tile=possibilities[qy][qx][0];for(const[nx,ny]of neighbors(qx,qy)){let poss=possibilities[ny][nx];if(poss.length>1){const allowedSet=allowF(tile);if(poss=poss.filter(v=>allowedSet.includes(v)),0===poss.length&&(poss=[Math.random()*tileCt|0]),poss.length!==possibilities[ny][nx].length){possibilities[ny][nx]=poss,queue.push([nx,ny])}}}}}}collapseOne();return possibilities.map(row=>row.map(cell=>cell[0]))}heightMap.length=0;colorMap.length=0;const heights=wfcLayer(4,t=>[t,(t+1)%4,(t+3)%4]),colors=wfcLayer(groundTileCount,allowed);for(let y=0;y<gridSize;y++){heightMap[y]=[];colorMap[y]=[];for(let x=0;x<gridSize;x++)heightMap[y][x]=heights[y][x],colorMap[y][x]=colors[y][x]}//object WFC layer const objCount=5,objColors=[0x111111,0xffbb00,0x42dfff,0xf833ff,0x00bc66];const objectChoices=['none','sphere','cube','cylinder','cone'];function objAllowed(t){return[0,1,2,3,4]}const objects=wfcLayer(objCount,objAllowed);objectTiles.length=0;for(let y=0;y<gridSize;y++){objectTiles[y]=[];for(let x=0;x<gridSize;x++)objectTiles[y][x]=objects[y][x]}scene.clear();const light=new THREE.DirectionalLight(16777215,1);light.position.set(0,3,2);scene.add(light);const amb=new THREE.AmbientLight(0x888888,0.45);scene.add(amb);const primitiveMesh={cube:new THREE.BoxGeometry(.6,.6,.6),sphere:new THREE.SphereGeometry(.35,12,10),cylinder:new THREE.CylinderGeometry(.31,.31,.61,14),cone:new THREE.ConeGeometry(.36,.6,9)};for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){const h=heightMap[y][x],c=colorMap[y][x],tileMesh=groundTiles[c].clone();tileMesh.position.set((x-gridSize/2)*tileSize,h*0.8+floorOffset,(y-gridSize/2)*tileSize);tileMesh.material=tileMesh.material.clone();tileMesh.material.color.setHex(groundColors[c]);tileMesh.geometry=tileMesh.geometry.clone();const col=new THREE.Color(groundColors[c]);col.lerp(new THREE.Color(0x222222),h*.2);let v=tileMesh.geometry;for(let vi=0;vi<v.attributes.position.count;vi++)v.attributes.color?0:v.setAttribute('color',new THREE.Float32BufferAttribute(Array(v.attributes.position.count*3).fill(0),3)),v.attributes.color.setXYZ(vi,col.r,col.g,col.b);scene.add(tileMesh);let ob=objectTiles[y][x];if(ob>0&&ob<objectChoices.length){let prim=objectChoices[ob];if(prim!=='none'){const m=new THREE.Mesh(primitiveMesh[prim],new THREE.MeshStandardMaterial({color:objColors[ob],emissive:0,positional:true}));m.position.set((x-gridSize/2)*tileSize,h*0.8+floorOffset+0.55,(y-gridSize/2)*tileSize);scene.add(m)}}}renderer.setClearColor(0x223344,1);renderer.xr.enabled=!0;renderer.setAnimationLoop(onRender);camera.position.set(0,playerHeight,0);let prevGamepads={};function getGamepadAxes(){const sess=renderer.xr.getSession();if(!sess)return[0,0,0,0];const inp=sess.inputSources;if(!inp.length)return[0,0,0,0];let lx=0,ly=0,rx=0,ry=0;for(const src of inp){if(!src.gamepad)continue;const g=src.gamepad;if(g.axes.length>=4){

// Oculus: Left=0/1, Right=2/3
[lx,ly,rx,ry]=[g.axes[0],g.axes[1],g.axes[2],g.axes[3]];break;}else if(g.axes.length>=2){lx=g.axes[0],ly=g.axes[1];}}return[lx,ly,rx,ry];}let rotAccum=0,snapDelay=0;function onRender(){// Handle VR movement
const[ljx,ljy,rjx,rjy]=getGamepadAxes();const dt=1/70,spd=2.6;let moveX=0,moveZ=0;let d=player.rot;moveZ=rjy;moveX=rjx;if(Math.abs(moveX)<.1)moveX=0;if(Math.abs(moveZ)<.1)moveZ=0;let fx=Math.sin(-d),fz=Math.cos(-d);player.x+=-moveZ*spd*dt*fx+moveX*spd*dt*fz;player.z+=-moveZ*spd*dt*fz-moveX*spd*dt*fx;rotAccum+=ljx;let snapThreshold=0.75;if(snapDelay>0)snapDelay-=dt;if(Math.abs(ljx)>snapThreshold&&snapDelay<=0){player.rot+=-(Math.sign(ljx))*Math.PI/6;snapDelay=0.3;}let px=(player.x/tileSize)+(gridSize/2),pz=(player.z/tileSize)+(gridSize/2);let rx=Math.floor(px),rz=Math.floor(pz),hh=0;if(rx>=0&&rx<gridSize&&rz>=0&&rz<gridSize)hh=heightMap[rz][rx]*0.8;camera.position.set(player.x,hh+playerHeight,player.z);camera.rotation.set(0,player.rot,0);renderer.render(scene,camera)};window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});</script></body></html>
