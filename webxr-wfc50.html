
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';let gridSize=12,tileSize=1.5,heightTiles=8,objTiles=8,colors=[16711680,65280,255,16776960,16711935,65535,16777215,8947848],heightPoss=[],objPoss=[];const scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);let cameraContainer=new THREE.Object3D();cameraContainer.add(camera);scene.add(cameraContainer);const light=new THREE.DirectionalLight(16777215,1);light.position.set(0,1,0);scene.add(light);let tiles=[];for(let i=0;i<heightTiles;i++){let g=new THREE.BoxGeometry(tileSize,.15*tileSize,tileSize),m=new THREE.MeshStandardMaterial({color:colors[i%colors.length]});tiles.push(new THREE.Mesh(g,m))}function allowed(t,cnt){return[t,(t+1)%cnt,(t+cnt-1)%cnt]}function neighbors(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>p[0]>=0&&p[0]<gridSize&&p[1]>=0&&p[1]<gridSize)}function collapse(poss,cnt){let unresolved=!0,guard=0;for(;unresolved&&guard<gridSize*gridSize*10;){guard++;let min=99,choices=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let l=poss[y][x].length;l>1&&l<min?(min=l,choices=[[x,y]]):l===min&&choices.push([x,y])}if(min===99){unresolved=!1;break}let[cx,cy]=choices[Math.random()*choices.length|0],options=poss[cy][cx],pick=options[Math.random()*options.length|0];poss[cy][cx]=[pick];let queue=[[cx,cy]];for(;queue.length;){let[qx,qy]=queue.shift(),tile=poss[qy][qx][0];for(let[nx,ny]of neighbors(qx,qy)){let p=poss[ny][nx];if(p.length>1){let a=allowed(tile,cnt);if(p=p.filter(v=>a.includes(v)),0===p.length&&(p=[Math.random()*cnt|0]),p.length!==poss[ny][nx].length){poss[ny][nx]=p,queue.push([nx,ny])}}}}}}for(let y=0;y<gridSize;y++){heightPoss[y]=[],objPoss[y]=[];for(let x=0;x<gridSize;x++)heightPoss[y][x]=Array(heightTiles).fill(0).map((_,i)=>i),objPoss[y][x]=Array(objTiles).fill(0).map((_,i)=>i)}collapse(heightPoss,heightTiles);collapse(objPoss,objTiles);let geometry=new THREE.PlaneGeometry(gridSize*tileSize,gridSize*tileSize,gridSize-1,gridSize-1),position=geometry.attributes.position,colorsAttr=[],heightMap=[];for(let y=0;y<gridSize;y++){heightMap[y]=[];for(let x=0;x<gridSize;x++){let h=heightPoss[y][x][0]/(heightTiles-1),i=y*gridSize+x;position.setY(i,h*2);heightMap[y][x]=h;let c=new THREE.Color(colors[heightPoss[y][x][0]%colors.length]);colorsAttr.push(c.r,c.g,c.b)}}geometry.setAttribute('color',new THREE.Float32BufferAttribute(colorsAttr,3));let mat=new THREE.MeshStandardMaterial({vertexColors:!0,flatShading:!0}),plane=new THREE.Mesh(geometry,mat);plane.rotation.x=-Math.PI/2;scene.add(plane);let primitiveColors=[0xff4444,0x11ff11,0x5555ff,0xffff33,0x22ffff,0xff22ff,0xbfbfbf,0x000000],primitiveG=[null,new THREE.BoxGeometry(.7,.7,.7),new THREE.SphereGeometry(.5,14,10),new THREE.CylinderGeometry(.4,.4,.8,12),new THREE.ConeGeometry(.5,.9,12),new THREE.TorusGeometry(.4,.17,8,16)];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let o=objPoss[y][x][0];if(0===o)continue;let g=primitiveG[o%primitiveG.length];if(!g)continue;let m=new THREE.MeshStandardMaterial({color:primitiveColors[o%primitiveColors.length]});let mesh=new THREE.Mesh(g,m);let h=heightMap[y][x]*2+.45;mesh.position.set((x-gridSize/2+.5)*tileSize,h,(y-gridSize/2+.5)*tileSize);scene.add(mesh)}let leftX=0,leftY=0,rightX=0,rightY=0,lastTurn=0;function handleGamepads(){let pads=navigator.getGamepads?navigator.getGamepads():[];for(let pad of pads)if(pad){if(pad.axes.length>=4){leftX=pad.axes[2],leftY=-pad.axes[3];rightX=pad.axes[0],rightY=-pad.axes[1];}else if(pad.axes.length>=2){rightX=pad.axes[0],rightY=-pad.axes[1]}}}let headAngle=0,snapInterval=Math.PI/6,lastSnap=0,desiredY=2.3,moveSpeed=.07;function getSurfaceY(x,z){let fx=(x/tileSize)+(gridSize/2),fz=(z/tileSize)+(gridSize/2);let ix=Math.floor(fx),iz=Math.floor(fz);if(ix<0||iz<0||ix>=gridSize-1||iz>=gridSize-1)return 0;let fracx=fx-ix,fracz=fz-iz;let h00=heightMap[iz][ix]*2,h10=heightMap[iz][ix+1]*2,h01=heightMap[iz+1][ix]*2,h11=heightMap[iz+1][ix+1]*2;let h0=h00*(1-fracx)+h10*fracx,h1=h01*(1-fracx)+h11*fracx;return h0*(1-fracz)+h1*fracz}renderer.setAnimationLoop((t)=>{handleGamepads();let dt=0.016;if(Math.abs(leftX)>0.3&&(t-lastSnap)>250){headAngle+=snapInterval*Math.sign(leftX);lastSnap=t}cameraContainer.rotation.y=headAngle;let dir=new THREE.Vector3(),q=new THREE.Quaternion();q.setFromAxisAngle(new THREE.Vector3(0,1,0),headAngle);dir.set(rightX,0,rightY).normalize().applyQuaternion(q);if(dir.lengthSq()>0.2){let move=dir.multiplyScalar(moveSpeed);cameraContainer.position.add(move);let x=cameraContainer.position.x,z=cameraContainer.position.z;let surf=getSurfaceY(x,z);cameraContainer.position.y=surf+desiredY;}renderer.render(scene,camera)});window.addEventListener('resize',()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();});</script></body></html>
