
<!DOCTYPE html><html><head><meta charset="utf-8"><title>WFC XR</title><style>body{margin:0;overflow:hidden}</style></head><body><script type="module">import*as THREE from'https://unpkg.com/three@0.157.0/build/three.module.js';import{VRButton}from'https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js';let scene=new THREE.Scene(),renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.xr.enabled=!0;document.body.appendChild(renderer.domElement);document.body.appendChild(VRButton.createButton(renderer));let camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3);let camYOff=1.7;camera.position.set(0,camYOff,3);let light=new THREE.DirectionalLight(16777215,1);light.position.set(0,1,0);scene.add(light);let gridSize=12,tileSize=2.2,baseHeight=0.22,elevBands=7,colorBands=[16711680,55280,255,16776960,111935,65535,16777215],objColors=[11184810,44285,14328503,5197647,14474460,0,16777215,15790320],objectTypes=['none','cube','sphere','cylinder'],objPool={cube:new THREE.BoxGeometry(tileSize*0.66,tileSize*0.6,tileSize*0.66),sphere:new THREE.SphereGeometry(tileSize*0.38,12,10),cylinder:new THREE.CylinderGeometry(tileSize*0.3,tileSize*0.3,tileSize*0.8,10)};let heightPoss=[],objPoss=[],heightWave=[],objWave=[];for(let y=0;y<gridSize;y++){heightPoss[y]=[];objPoss[y]=[];for(let x=0;x<gridSize;x++){heightPoss[y][x]=[0,1,2,3,4,5,6];objPoss[y][x]=[0,1,2,3];}}function allowedBands(k){return[k,(k+1)%elevBands,(k+elevBands-1)%elevBands]}function nbs(x,y){return[[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>p[0]>=0&&p[0]<gridSize&&p[1]>=0&&p[1]<gridSize)}function collapse(p,allowedFn,maxval){let unresolved=!0,loops=0;while(unresolved&&loops<gridSize*gridSize*20){loops++;let min=maxval+1,co=[];for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let l=p[y][x].length;l>1&&l<min?(min=l,co=[[x,y]]):l===min&&co.push([x,y])}if(min===maxval+1){unresolved=!1;break;}let[cx,cy]=co[Math.random()*co.length|0],opts=p[cy][cx],pick=opts[Math.random()*opts.length|0];p[cy][cx]=[pick];let q=[[cx,cy]];while(q.length){let[qx,qy]=q.shift(),v=p[qy][qx][0];for(let[nx,ny]of nbs(qx,qy)){let poss=p[ny][nx];if(poss.length>1){let as=allowedFn?v=>allowedFn(v).includes(p[qy][qx][0]):()=>!0;poss=poss.filter(as);if(!poss.length)poss=[Math.random()*maxval|0];if(poss.length!==p[ny][nx].length)q.push([nx,ny]);p[ny][nx]=poss;}}}}return p.map(a=>a.map(b=>b[0]));}heightWave=collapse(heightPoss,allowedBands,elevBands-1);function allowedObjTypes(a){return[0,1,2,3]}objWave=collapse(objPoss,allowedObjTypes,3);for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++){let hCode=heightWave[y][x],h=(hCode/elevBands)*4.2*tileSize,vc=colorBands[hCode%colorBands.length],geo=new THREE.BoxGeometry(tileSize,baseHeight+0.6*h,tileSize),mat=new THREE.MeshStandardMaterial({color:vc,vertexColors:!1}),mesh=new THREE.Mesh(geo,mat);mesh.position.set((x-gridSize/2)*tileSize,0.5*(baseHeight+0.6*h), (y-gridSize/2)*tileSize);scene.add(mesh);let o=objWave[y][x];if(o!==0){let tp=objectTypes[o],ocol=objColors[o],omat=new THREE.MeshStandardMaterial({color:ocol}),omesh=new THREE.Mesh(objPool[tp],omat);omesh.position.set((x-gridSize/2)*tileSize,baseHeight+0.6*h+tileSize*0.36,(y-gridSize/2)*tileSize);scene.add(omesh);}}let yaw=0,pPos=new THREE.Vector3(0,camYOff,3),pVel=new THREE.Vector3(),snapAngle=THREE.MathUtils.degToRad(40),snapTimeout=0,moveVel=0.12,controllerInfo=[];renderer.xr.addEventListener("sessionstart",()=>{let session=renderer.xr.getSession();controllerInfo=[session.inputSources[0],session.inputSources[1]];});function handleXRMove(){let sess=renderer.xr.getSession();if(!sess)return;for(let inputSrc of sess.inputSources){if(inputSrc&&inputSrc.gamepad&&inputSrc.handedness){let gp=inputSrc.gamepad,ls=gp.axes,btns=gp.buttons;let isL=inputSrc.handedness==="left",isR=inputSrc.handedness==="right";if(isL&&Math.abs(ls[2])>0.6&&snapTimeout<=0){yaw+=Math.sign(ls[2])*snapAngle;snapTimeout=20;}if(isL){}if(isR){let fwd=-ls[3]||0,side=ls[2]||0,dir=new THREE.Vector3();dir.set(Math.sin(yaw),0,Math.cos(yaw)).multiplyScalar(fwd*moveVel).add(new THREE.Vector3(Math.sin(yaw+Math.PI/2),0,Math.cos(yaw+Math.PI/2)).multiplyScalar(side*moveVel));pVel.copy(dir);}}}}}renderer.setAnimationLoop(()=>{handleXRMove();yaw%=Math.PI*2;if(snapTimeout>0)--snapTimeout;if(pVel.lengthSq()>0){pPos.add(pVel);}else{pVel.multiplyScalar(0.6);}let gx=Math.floor((pPos.x+gridSize/2*tileSize)/tileSize),gy=Math.floor((pPos.z+gridSize/2*tileSize)/tileSize);gx=Math.max(0,Math.min(gridSize-1,gx));gy=Math.max(0,Math.min(gridSize-1,gy));let hIdx=heightWave[gy]?heightWave[gy][gx]:0,gh=(hIdx/elevBands)*4.2*tileSize;let goalY=baseHeight+0.6*gh+camYOff;pPos.y=goalY;camera.position.copy(pPos);camera.rotation.set(0,yaw,0,"YXZ");renderer.render(scene,camera);});window.addEventListener('resize',()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();});</script></body></html>
```
